# âœ… **PARTE 1 â€” O que tens MESMO de fazer**

Tens de desenvolver **uma aplicaÃ§Ã£o em C** que faÃ§a:

```
download ftp://ftp.netlab.fe.up.pt/pub/.../ficheiro
```

Ou seja:

1. **Ler um URL FTP** (`ftp://[user:password@]host/path`)
2. **Obter o IP do host usando gethostbyname()**
3. **Criar uma ligaÃ§Ã£o TCP ao servidor FTP (porto 21)** â†’ conexÃ£o de controlo
4. **Enviar os comandos FTP bÃ¡sicos:**

   * USER
   * PASS
   * PASV
   * RETR <path>
5. **Interpretar a resposta do comando PASV**

   * Obter o IP e porto para a **ligaÃ§Ã£o de dados**
6. **Criar uma segunda ligaÃ§Ã£o TCP**

   * Para receber o **ficheiro**
7. **Guardar o ficheiro na diretoria atual**
8. **Fechar ligaÃ§Ãµes e terminar**

---

# ğŸ¯ **Fluxo da tua aplicaÃ§Ã£o (use case obrigatÃ³rio)**

O guiÃ£o define isto:

| Etapa | O que faz                                |
| ----- | ---------------------------------------- |
| 1     | Conectar ao host FTP (porta 21)          |
| 2     | Fazer login                              |
| 3     | Passive Mode                             |
| 4     | Pedir o ficheiro (`RETR path`)           |
| 5     | Receber o ficheiro pela ligaÃ§Ã£o de dados |
| 6     | Guardar ficheiro no disco                |
| 7     | Indicar sucesso ou falha                 |

---

# ğŸ“Œ **CÃ³digo fornecido: Para que serve**

### 1ï¸âƒ£ **getIP.c**

Serve para te ensinar a usar:

* `gethostbyname()`
* `inet_ntoa()`

Isto vai ser usado para resolver o `host` que vier no URL.

### 2ï¸âƒ£ **clientTCP.c**

Mostra como:

* criar sockets TCP,
* definir `sockaddr_in`,
* usar `connect()`,
* enviar dados com `write()`.

Vais reutilizar exatamente esta estrutura para:

* **conexÃ£o de controlo (porto 21)**
* **conexÃ£o de dados (porto via PASV)**

---

# ğŸš€ **Como comeÃ§ar (passo a passo simples)**

## **Passo 1 â€” Parse do URL**

Ex.:
`ftp://user:pass@ftp.netlab.fe.up.pt/pub/file.txt`

Extrair:

* utilizador (default "anonymous")
* password (default "anonymous@")
* host: `ftp.netlab.fe.up.pt`
* caminho: `/pub/file.txt`
* nome do ficheiro final: `file.txt`

---

## **Passo 2 â€” Obter IP do host**

Usa cÃ³digo **igual ao getIP.c**:

```c
struct hostent *h;
h = gethostbyname(host);
```

---

## **Passo 3 â€” Criar socket de controlo (porto 21)**

Com base no **clientTCP.c**:

```c
socket(AF_INET, SOCK_STREAM, 0);
connect(... porto 21 ...)
```

---

## **Passo 4 â€” Ler mensagem de boas-vindas (220)**

Usar `read()` para receber linhas.

---

## **Passo 5 â€” Enviar USER / PASS**

Exemplo:

```
USER anonymous\r\n
PASS anonymous@\r\n
```

---

## **Passo 6 â€” Entrar em modo passivo**

Enviar:

```
PASV\r\n
```

O servidor responde:

```
227 Entering Passive Mode (h1,h2,h3,h4,p1,p2)
```

A porta Ã©:

```
port = p1*256 + p2
```

O IP Ã© `h1.h2.h3.h4`.

---

## **Passo 7 â€” Abrir segunda ligaÃ§Ã£o TCP**

LigaÃ§Ãµes:

* **controlo** â†’ continua aberta no porto 21
* **dados** â†’ nova ligaÃ§Ã£o TCP ao porto calculado acima

---

## **Passo 8 â€” Enviar RETR**

```
RETR /pub/file.txt\r\n
```

O servidor envia:

* resposta 150 (a iniciar transferÃªncia)
* dados do ficheiro na segunda ligaÃ§Ã£o

---

## **Passo 9 â€” Receber dados e guardar em ficheiro**

Loop:

```c
while ((n = read(data_socket, buffer, sizeof(buffer))) > 0)
    write(file_fd, buffer, n);
```

---

## **Passo 10 â€” Fechar tudo**

* fechar ligaÃ§Ã£o de dados
* ler resposta final (226)
* enviar QUIT
* fechar ligaÃ§Ã£o de controlo

---

# ğŸ§± **Arquitetura tÃ­pica do teu cÃ³digo**

```
main()
 â”œâ”€â”€ parse_url()
 â”œâ”€â”€ resolve_host()         (usa gethostbyname)
 â”œâ”€â”€ connect_control()      (socket + connect porto 21)
 â”œâ”€â”€ ftp_login()            (USER, PASS)
 â”œâ”€â”€ ftp_pasv()             (ler IP e porto do modo passivo)
 â”œâ”€â”€ connect_data()         (nova socket)
 â”œâ”€â”€ ftp_retr()             (pedir ficheiro)
 â”œâ”€â”€ download_file()
 â”œâ”€â”€ ftp_quit()
 â””â”€â”€ close sockets
```

---

# ğŸ“ **Queres que te prepare a estrutura base em C?**

Posso gerar:

âœ” ficheiro `download.c` completo com:

* parsing de URL
* sockets
* leitura de respostas FTP
* passive mode
* download binÃ¡rio
* tratamento de erros
* comentÃ¡rios explicativos

SÃ³ tens de me dizer:

ğŸ‘‰ **Queres o cÃ³digo completo jÃ¡ pronto para compilar no Ubuntu/tux?**

Ou preferes:

ğŸ‘‰ **Uma versÃ£o mais simples para ires completando durante a aula?**
